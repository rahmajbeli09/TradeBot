# Plan de validation des performances de la recherche sémantique (RAG)

## Objectif
Valider la pertinence, la rapidité et la robustesse de la recherche RAG sur les mappings indexés dans Qdrant, sans modifier les données source.

---

## 1) Jeu de requêtes tests couvrant tous les msgType

### Requêtes directes (par msgType)
- "Que signifie le Champ 4 du msgType 16 ?"
- "Explique le champ montant de l'opération du msgType 53"
- "Description du msgType A3"
- "Champ 1 du msgType 03"
- "Code de sous-type du msgType 16"

### Requêtes sémantiques (variations)
- "Je veux comprendre le champ identifiant unique"
- "Montant de l'opération"
- "Type de message principal"
- "Référence externe"
- "Horodatage ou date"
- "Code de statut"
- "Prix unitaire ou taux"

### Requêtes ambiguës / limites
- "Champ inconnu"
- "Information sur un msgType qui n'existe pas"
- "Données manquantes"
- "Requête vide ou seulement des mots vides"

---

## 2) Exécution de la recherche RAG

Pour chaque requête :
- Appeler `POST /api/embeddings/search` avec `{ "query": "...", "limit": 3 }`
- Extraire le top‑k résultats (k=3 par défaut)
- Noter le temps de réponse (ms)

---

## 3) Comparaison avec la vérité terrain

Pour chaque résultat retourné :
- Vérifier que le `msgType` correspond bien à celui attendu
- Vérifier que les significations des champs sont exactes
- Noter le score de similarité

---

## 4) Métriques à calculer

### Par requête
- **Top‑1 correct ?** (booléen) : le premier résultat est‑il le bon msgType ?
- **Score moyen** : moyenne des scores de similarité des résultats retournés
- **Temps de réponse** : durée totale (ms) entre l’appel API et la réponse

### Globales
- **% Top‑1 correct** : (nombre de requêtes avec top‑1 correct) / (total requêtes)
- **Score moyen global** : moyenne de tous les scores
- **Temps moyen de réponse** : moyenne des temps de réponse

---

## 5) Cas limites et anomalies

- **msgType inconnu** : que retourne Qdrant pour une requête sans correspondance ?
- **Champs vides/anonymisés** : impact sur la pertinence
- **Requêtes vides** : comportement du système
- **Scores très bas** : si < 0.5, considérer comme non pertinent

---

## 6) Rapport attendu

### Par requête (JSON)
```json
{
  "query": "Que signifie le Champ 4 du msgType 16 ?",
  "top_k": 3,
  "results": [
    {
      "msgType": "16",
      "score": 0.769,
      "mapping": { "Champ 4": "Montant de l'opération", ... },
      "status": "Validé"
    }
  ],
  "metrics": {
    "top1_correct": true,
    "avg_score": 0.74,
    "response_time_ms": 45
  }
}
```

### Synthèse globale
- Total requêtes testées
- % Top‑1 correct
- Score moyen global
- Temps moyen de réponse
- Anomalies détectées

---

## 7) Outils de mesure

- **curl** pour mesurer le temps de réponse (`-w "%{time_total}\n"`)
- **Logs Spring Boot** pour les scores et temps internes
- **MongoDB** : vérifier que les mappings comparés sont bien les versions validées

---

## 8) Contraintes respectées

- Aucune modification des données source
- Utilisation uniquement des documents déjà indexés
- Historique des versions et anonymisation conservés
- Pas d’avancée vers une autre étape du projet
